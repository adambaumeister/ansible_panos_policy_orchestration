---
# Runs test security-policy-match based on the given parameters

- name: Test the Current Security policy
  block:
    - name: Test the current status of the security policy using all parameters
      paloaltonetworks.panos.panos_op:
        provider:
          ip_address: "{{ provider.ip_address }}"
          username: "{{ provider.username }}"
          password: "{{ provider.password }}"
          serial_number: "{{ item.serial }}"
        cmd: |
          <test>
            <security-policy-match>
              <source>{{ source_ip }}</source>
              <destination>{{ destination_ip }}</destination>
              <application>{{ application }}</application>
              <protocol>{{ protocol }}</protocol>
              <destination-port>{{ destination_port }}</destination-port>
            </security-policy-match>
          </test>
        cmd_is_xml: true
      register: security_policy_match_result
  rescue:
    - name: Test the current status of the security policy using PLACEHOLDERS
      paloaltonetworks.panos.panos_op:
        provider:
          ip_address: "{{ provider.ip_address }}"
          username: "{{ provider.username }}"
          password: "{{ provider.password }}"
          serial_number: "{{ item.serial }}"
        cmd: |
          <test>
            <security-policy-match>
              <source>{{ source_ip }}</source>
              <destination>{{ destination_ip }}</destination>
              <application>ssl</application>
              <protocol>6</protocol>
              <destination-port>443</destination-port>
            </security-policy-match>
          </test>
        cmd_is_xml: true
      register: security_policy_match_result

- name: Set the policy match result
  set_fact:
    matches_existing_policy: "{{ security_policy_match_result | panos_op_policy_match_result_to_bool }}"
